# ğŸ¨ Fulfillment Process Visual Diagrams

## Current State (BLOCKING ARCHITECTURE)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         CUSTOMER JOURNEY                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Customer â†’ App.jsx â†’ /api/create-checkout â†’ Stripe Checkout â†’ Payment
                                                                  â†“
                                                           [Stripe fires webhook]
                                                                  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              STRIPE WEBHOOK (BLOCKING - 30s timeout)                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                         â”‚
â”‚  â±ï¸  Step 1: Verify Signature                  [500ms]                 â”‚
â”‚      â”‚                                                                  â”‚
â”‚      â”œâ”€â”€â–º FAIL? â†’ Return 200 (logged)                                  â”‚
â”‚      â””â”€â”€â–º PASS âœ…                                                       â”‚
â”‚                                                                         â”‚
â”‚  â±ï¸  Step 2: Check Idempotency (DB Query)      [300ms]                 â”‚
â”‚      â”‚                                                                  â”‚
â”‚      â”œâ”€â”€â–º EXISTS? â†’ Return 200 (skip)                                  â”‚
â”‚      â””â”€â”€â–º NEW âœ…                                                        â”‚
â”‚                                                                         â”‚
â”‚  â±ï¸  Step 3: Generate QR Code (Sync)           [100ms]                 â”‚
â”‚      â”‚                                                                  â”‚
â”‚      â””â”€â”€â–º QR Base64 Data URL âœ…                                        â”‚
â”‚                                                                         â”‚
â”‚  â±ï¸  Step 4: Insert Ticket (5s timeout)        [2-5s] âš ï¸               â”‚
â”‚      â”‚                                                                  â”‚
â”‚      â”œâ”€â”€â–º TIMEOUT? â†’ Return 200 (logged) âŒ                            â”‚
â”‚      â”œâ”€â”€â–º FAIL? â†’ Return 200 (logged) âŒ                               â”‚
â”‚      â””â”€â”€â–º SUCCESS âœ…                                                    â”‚
â”‚                                                                         â”‚
â”‚  â±ï¸  Step 5: Send Email (5s timeout)           [2-5s] âš ï¸               â”‚
â”‚      â”‚                                                                  â”‚
â”‚      â”œâ”€â”€â–º TIMEOUT? â†’ Return 200 (logged) âŒ [CUSTOMER LOST TICKET]    â”‚
â”‚      â”œâ”€â”€â–º FAIL? â†’ Return 200 (logged) âŒ [CUSTOMER LOST TICKET]       â”‚
â”‚      â””â”€â”€â–º SUCCESS âœ…                                                    â”‚
â”‚                                                                         â”‚
â”‚  â±ï¸  Step 6: Return 200 to Stripe              [10ms]                  â”‚
â”‚                                                                         â”‚
â”‚  â±ï¸  TOTAL TIME: 5-11s (best) | 30s+ (worst)                           â”‚
â”‚                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
                    Customer â†’ /success
                            â†“
                 (maybe gets email... maybe not)


â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ğŸš¨ FAILURE MODES (CURRENT)                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                         â”‚
â”‚  1. Supabase Slow (>5s) â†’ Timeout â†’ Ticket Lost âŒ                     â”‚
â”‚     - Stripe retries webhook â†’ Idempotency prevents duplicate           â”‚
â”‚     - But customer never gets ticket                                    â”‚
â”‚     - Manual intervention required                                      â”‚
â”‚                                                                         â”‚
â”‚  2. Resend Fails â†’ Email Not Sent âŒ                                   â”‚
â”‚     - Ticket saved to DB âœ…                                             â”‚
â”‚     - Email never delivered âŒ                                          â”‚
â”‚     - Customer has no way to retrieve                                   â”‚
â”‚     - Manual intervention required                                      â”‚
â”‚                                                                         â”‚
â”‚  3. Function Times Out (>30s) â†’ Stripe Retries âš ï¸                      â”‚
â”‚     - Webhook function killed mid-execution                             â”‚
â”‚     - Stripe sees no response â†’ Retries (up to 3 days)                 â”‚
â”‚     - Idempotency check prevents duplicates                             â”‚
â”‚     - But wastes resources + delays fulfillment                         â”‚
â”‚                                                                         â”‚
â”‚  4. Cold Start Latency â†’ Slow Response â±ï¸                              â”‚
â”‚     - First request after idle: +500ms-2s                               â”‚
â”‚     - Creates new Supabase connection: +200ms                           â”‚
â”‚     - Total: 5-11s â†’ Close to timeout risk                              â”‚
â”‚                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ESTIMATED FAILURE RATE: 10-15% (requires manual intervention)
```

---

## Proposed Architecture (ASYNC QUEUE)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         CUSTOMER JOURNEY                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Customer â†’ App.jsx â†’ /api/create-checkout â†’ Stripe Checkout â†’ Payment
                                                                  â†“
                                                           [Stripe fires webhook]
                                                                  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              STRIPE WEBHOOK (FAST - responds in <3s)                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                         â”‚
â”‚  â±ï¸  Step 1: Verify Signature                  [500ms]                 â”‚
â”‚      â””â”€â”€â–º PASS âœ…                                                       â”‚
â”‚                                                                         â”‚
â”‚  â±ï¸  Step 2: Check Idempotency                 [300ms]                 â”‚
â”‚      â””â”€â”€â–º NEW âœ…                                                        â”‚
â”‚                                                                         â”‚
â”‚  â±ï¸  Step 3: Generate QR Code                  [100ms]                 â”‚
â”‚      â””â”€â”€â–º QR Base64 Data URL âœ…                                        â”‚
â”‚                                                                         â”‚
â”‚  â±ï¸  Step 4: Insert Ticket + Queue Email Job   [1-2s] âœ…               â”‚
â”‚      â”‚                                                                  â”‚
â”‚      â”œâ”€â”€â–º tickets.insert() â†’ DB row created                            â”‚
â”‚      â””â”€â”€â–º email_queue.insert() â†’ Job created                           â”‚
â”‚                                                                         â”‚
â”‚  â±ï¸  Step 5: Return 200 to Stripe              [10ms]                  â”‚
â”‚                                                                         â”‚
â”‚  â±ï¸  TOTAL TIME: 1-3s (always fast!)           âœ…                      â”‚
â”‚                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
                    Customer â†’ /success
                            â†“
                     (ticket always saved âœ…)


                        [1 minute later...]

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         BACKGROUND EMAIL WORKER (Vercel Cron - runs every 1min)        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                         â”‚
â”‚  Step 1: Fetch Pending Jobs (LIMIT 10)                                 â”‚
â”‚      â†“                                                                  â”‚
â”‚  [Job 1] [Job 2] [Job 3] ... [Job 10]                                  â”‚
â”‚                                                                         â”‚
â”‚  Step 2: Process Each Job (with retry logic)                           â”‚
â”‚      â”‚                                                                  â”‚
â”‚      â”œâ”€â”€â–º Send Email via Resend                                        â”‚
â”‚      â”‚     â”‚                                                            â”‚
â”‚      â”‚     â”œâ”€â”€â–º SUCCESS âœ… â†’ Mark as 'sent'                            â”‚
â”‚      â”‚     â”‚                                                            â”‚
â”‚      â”‚     â””â”€â”€â–º FAIL âŒ â†’ Increment retry_count                        â”‚
â”‚      â”‚          â”‚                                                       â”‚
â”‚      â”‚          â”œâ”€â”€â–º retry_count < 3 â†’ Status stays 'pending'          â”‚
â”‚      â”‚          â”‚    (will retry next run)                              â”‚
â”‚      â”‚          â”‚                                                       â”‚
â”‚      â”‚          â””â”€â”€â–º retry_count >= 3 â†’ Status = 'failed'              â”‚
â”‚      â”‚               (log to errors table, manual intervention)         â”‚
â”‚      â”‚                                                                  â”‚
â”‚      â””â”€â”€â–º Log Results                                                  â”‚
â”‚                                                                         â”‚
â”‚  Step 3: Return Stats                                                  â”‚
â”‚      {                                                                  â”‚
â”‚        processed: 10,                                                   â”‚
â”‚        success: 9,                                                      â”‚
â”‚        failures: 1                                                      â”‚
â”‚      }                                                                  â”‚
â”‚                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
                 Customer receives email âœ…
                 (within 1-2 minutes, 99%+ success)


â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    âœ… IMPROVED RELIABILITY                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                         â”‚
â”‚  1. Webhook Always Succeeds                                            â”‚
â”‚     - Responds in <3s (fast!)                                           â”‚
â”‚     - Ticket always saved to DB âœ…                                      â”‚
â”‚     - Email queued for later âœ…                                         â”‚
â”‚     - No customer-facing failures âœ…                                    â”‚
â”‚                                                                         â”‚
â”‚  2. Email Delivery Retries (3 attempts)                                â”‚
â”‚     - Transient failures (rate limits, network) auto-retry              â”‚
â”‚     - 99%+ eventual delivery                                            â”‚
â”‚     - Only persistent failures need manual intervention                 â”‚
â”‚                                                                         â”‚
â”‚  3. Background Processing                                              â”‚
â”‚     - Doesn't block webhook response                                    â”‚
â”‚     - Can handle bursts (100+ purchases/minute)                         â”‚
â”‚     - Processes 10 emails/minute (600/hour)                             â”‚
â”‚                                                                         â”‚
â”‚  4. Visibility & Monitoring                                            â”‚
â”‚     - email_queue table shows delivery status                           â”‚
â”‚     - errors table logs failures                                        â”‚
â”‚     - Easy to query stuck jobs                                          â”‚
â”‚                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ESTIMATED FAILURE RATE: <1% (manual intervention)
```

---

## Database Schema (Email Queue)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    email_queue TABLE                                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                         â”‚
â”‚  id              UUID (PRIMARY KEY)                                     â”‚
â”‚  ticket_id       TEXT (UNIQUE with status IN pending/sent)             â”‚
â”‚  recipient_email TEXT                                                   â”‚
â”‚  recipient_name  TEXT                                                   â”‚
â”‚  qr_code_data    TEXT (base64 or storage URL)                          â”‚
â”‚  event_id        TEXT                                                   â”‚
â”‚  status          TEXT (pending | sent | failed)                        â”‚
â”‚  retry_count     INT (default: 0)                                       â”‚
â”‚  last_error      TEXT                                                   â”‚
â”‚  created_at      TIMESTAMPTZ (default: NOW())                          â”‚
â”‚  processed_at    TIMESTAMPTZ                                            â”‚
â”‚                                                                         â”‚
â”‚  Indexes:                                                               â”‚
â”‚  - idx_email_queue_status (status)                                     â”‚
â”‚  - idx_email_queue_created (created_at)                                â”‚
â”‚  - idx_email_queue_ticket (ticket_id)                                  â”‚
â”‚                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Job Lifecycle:
1. Created by webhook â†’ status='pending', retry_count=0
2. Worker picks up â†’ Sends email
   - Success â†’ status='sent', processed_at=NOW()
   - Failure â†’ retry_count++
3. If retry_count >= 3 â†’ status='failed'
```

---

## Email Delivery Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   EMAIL RETRY STATE MACHINE                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

                   [Job Created]
                        â†“
                    status='pending'
                   retry_count=0
                        â†“
                   [Worker Picks Up]
                        â†“
                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                  â”‚ Send Email  â”‚
                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚                           â”‚
      [SUCCESS âœ…]                [FAIL âŒ]
          â”‚                           â”‚
   status='sent'              retry_count++
   processed_at=NOW()                 â”‚
          â”‚                           â”‚
          â””â”€â”€â–º DONE âœ…          retry_count < 3?
                                      â”‚
                          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                          â”‚                       â”‚
                        [YES]                   [NO]
                          â”‚                       â”‚
                  status='pending'        status='failed'
                  (retry next run)        log to errors table
                          â”‚                       â”‚
                          â””â”€â”€â–º [Wait 1 min]       â””â”€â”€â–º DONE âŒ
                                    â†“                (manual intervention)
                             [Worker Retry]
```

---

## Performance Comparison

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    BEFORE (BLOCKING)                                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                         â”‚
â”‚  Webhook Timeline:                                                      â”‚
â”‚  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•       â”‚
â”‚  0s   1s   2s   3s   4s   5s   6s   7s   8s   9s   10s  11s            â”‚
â”‚  â”‚â”€â”€â”€â”€â”‚â”€â”€â”€â”€â”‚â”€â”€â”€â”€â”‚â”€â”€â”€â”€â”‚â”€â”€â”€â”€â”‚â”€â”€â”€â”€â”‚â”€â”€â”€â”€â”‚â”€â”€â”€â”€â”‚â”€â”€â”€â”€â”‚â”€â”€â”€â”€â”‚â”€â”€â”€â”€â”‚              â”‚
â”‚  â”‚ Verify                                                               â”‚
â”‚  â”‚    â”‚ Idempotency                                                     â”‚
â”‚  â”‚    â”‚   â”‚ QR                                                          â”‚
â”‚  â”‚    â”‚   â”‚  â”‚ DB Insert â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º                               â”‚
â”‚  â”‚    â”‚   â”‚  â”‚                         â”‚ Email Send â”€â”€â”€â”€â”€â”€â”€â”€â–º          â”‚
â”‚  â”‚    â”‚   â”‚  â”‚                         â”‚                    â”‚ Done      â”‚
â”‚  â””â”€â”€â”€â”€â”´â”€â”€â”€â”´â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â–º       â”‚
â”‚                                                                         â”‚
â”‚  Total: 5-11s                                                           â”‚
â”‚  Failure Point: Any step fails â†’ Customer impact                       â”‚
â”‚                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    AFTER (ASYNC QUEUE)                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                         â”‚
â”‚  Webhook Timeline:                                                      â”‚
â”‚  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•                                        â”‚
â”‚  0s   1s   2s   3s                                                      â”‚
â”‚  â”‚â”€â”€â”€â”€â”‚â”€â”€â”€â”€â”‚â”€â”€â”€â”€â”‚                                                       â”‚
â”‚  â”‚ Verify                                                               â”‚
â”‚  â”‚    â”‚ Idempotency                                                     â”‚
â”‚  â”‚    â”‚   â”‚ QR                                                          â”‚
â”‚  â”‚    â”‚   â”‚  â”‚ DB Insert + Queue â–º                                     â”‚
â”‚  â”‚    â”‚   â”‚  â”‚                    â”‚ Done âœ…                             â”‚
â”‚  â””â”€â”€â”€â”€â”´â”€â”€â”€â”´â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â–º                                 â”‚
â”‚                                                                         â”‚
â”‚  Total: 1-3s (60% faster!)                                              â”‚
â”‚  Failure Point: None - ticket always saved âœ…                           â”‚
â”‚                                                                         â”‚
â”‚  Background Email (separate, async):                                   â”‚
â”‚  [Wait 1 min] â†’ Send Email (3 retries) â†’ 99%+ delivery                 â”‚
â”‚                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## System Health Monitoring

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              EMAIL QUEUE HEALTH DASHBOARD (SQL Queries)                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

-- 1. Overall Success Rate (Last 24h)
SELECT 
  status,
  COUNT(*) as count,
  ROUND(COUNT(*) * 100.0 / SUM(COUNT(*)) OVER(), 2) as percentage
FROM email_queue
WHERE created_at > NOW() - INTERVAL '24 hours'
GROUP BY status;

Expected:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ status  â”‚ count â”‚ percentage â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ sent    â”‚  950  â”‚   95.00%   â”‚ âœ… Good
â”‚ pending â”‚   40  â”‚    4.00%   â”‚ âœ… Acceptable
â”‚ failed  â”‚   10  â”‚    1.00%   â”‚ âš ï¸  Monitor
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


-- 2. Retry Distribution
SELECT 
  retry_count,
  COUNT(*) as count
FROM email_queue
WHERE created_at > NOW() - INTERVAL '24 hours'
GROUP BY retry_count
ORDER BY retry_count;

Expected:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”
â”‚ retry_count  â”‚ count â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚      0       â”‚  950  â”‚ âœ… Most succeed first try
â”‚      1       â”‚   30  â”‚ âœ… Some retry once
â”‚      2       â”‚   10  â”‚ âš ï¸  Few retry twice
â”‚      3       â”‚   10  â”‚ âŒ Failed (manual fix)
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”˜


-- 3. Failed Jobs (Needs Attention)
SELECT 
  ticket_id,
  recipient_email,
  last_error,
  retry_count,
  created_at
FROM email_queue
WHERE status = 'failed'
  AND created_at > NOW() - INTERVAL '7 days'
ORDER BY created_at DESC;

Example Output:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ticket_id   â”‚ recipient_email      â”‚ last_error     â”‚ retries â”‚ created_at â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ cs_test_123 â”‚ bounce@example.com   â”‚ Email bounced  â”‚    3    â”‚ 2025-12-09 â”‚
â”‚ cs_test_456 â”‚ invalid@invalid.com  â”‚ Invalid email  â”‚    3    â”‚ 2025-12-09 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Quick Reference: Troubleshooting

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    COMMON ISSUES & FIXES                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                         â”‚
â”‚  Symptom: Emails stuck in 'pending'                                    â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                  â”‚
â”‚  Check: Vercel cron logs (vercel logs --follow)                        â”‚
â”‚  Cause: Worker not running or crashing                                 â”‚
â”‚  Fix:                                                                   â”‚
â”‚    1. Verify vercel.json has crons configured                          â”‚
â”‚    2. Check CRON_SECRET env var                                        â”‚
â”‚    3. Manually trigger: curl -X POST /api/process-email-queue          â”‚
â”‚                                                                         â”‚
â”‚  Symptom: High 'failed' count                                          â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                            â”‚
â”‚  Check: email_queue.last_error column                                  â”‚
â”‚  Cause: Resend API key invalid or rate limit hit                       â”‚
â”‚  Fix:                                                                   â”‚
â”‚    1. Regenerate Resend API key                                        â”‚
â”‚    2. Update RESEND_API_KEY in Vercel                                  â”‚
â”‚    3. Check Resend dashboard for rate limits                           â”‚
â”‚                                                                         â”‚
â”‚  Symptom: Webhook timeout (rare after fix)                             â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                             â”‚
â”‚  Check: Vercel logs for timeout errors                                 â”‚
â”‚  Cause: Supabase insert taking >5s                                     â”‚
â”‚  Fix:                                                                   â”‚
â”‚    1. Check Supabase performance dashboard                             â”‚
â”‚    2. Verify indexes exist (idx_tickets_ticket_id)                     â”‚
â”‚    3. Consider upgrading Supabase plan                                 â”‚
â”‚                                                                         â”‚
â”‚  Symptom: Duplicate emails sent                                        â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                           â”‚
â”‚  Check: email_queue for duplicate ticket_id                            â”‚
â”‚  Cause: Unique constraint not working                                  â”‚
â”‚  Fix:                                                                   â”‚
â”‚    1. Run: CREATE UNIQUE INDEX idx_email_queue_unique_ticket ...       â”‚
â”‚    2. Delete duplicates manually                                       â”‚
â”‚                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Architecture Decision Record (ADR)

**Decision:** Implement async email queue with cron worker

**Context:**
- Current webhook blocks on email send (5-11s response time)
- Email failures cause customer-facing impact
- No retry mechanism for transient failures
- Webhook timeout risk (30s Vercel limit)

**Alternatives Considered:**
1. **Increase timeouts** â†’ Doesn't solve root cause
2. **Use external queue (Bull, BullMQ)** â†’ Requires Redis (extra cost)
3. **Use Vercel Queue (Beta)** â†’ Not stable/GA yet
4. **Async email queue + cron** â†’ âœ… **CHOSEN**

**Rationale:**
- Leverages existing infrastructure (Supabase + Vercel Cron)
- No additional services/costs
- Simple to implement (4-6 hours)
- Backwards compatible (can rollback easily)
- Proven pattern (used by Stripe, Shopify, etc.)

**Consequences:**
- âœ… Webhook responds 60% faster (1-3s vs 5-11s)
- âœ… Zero customer-facing failures
- âœ… 99%+ email delivery (up from 70-80%)
- âœ… Automatic retries (3 attempts)
- âš ï¸ Slight delay (1-2 min) before email received
- âš ï¸ Need to monitor email_queue table

**Status:** Approved for implementation

---

**Visual Diagrams Complete**  
**Next:** Implement Fix #1 using FULFILLMENT_FIX_IMPLEMENTATION.md guide

